name: Encode & Upload Assets
on:
  workflow_dispatch:
    inputs:
      video_name:
        description: "Name of the asset (used for output path)"
        required: true
        type: string
      alpha_side:
        description: "Which half contains the alpha matte"
        required: true
        type: choice
        options:
          - right
          - left
      invert:
        description: "Invert the alpha matte"
        required: false
        type: boolean
        default: false
      cdn_path:
        description: "CDN upload path (e.g. room/gifts/vip-gifts)"
        required: false
        type: string
        default: "/"
      skip_webm:
        description: "Skip WebM encoding (already done locally)"
        required: false
        type: boolean
        default: false

jobs:
  encode-and-upload:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ffmpeg
        run: brew install ffmpeg

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Check raw video exists
        run: |
          if [ ! -f "raw/${{ inputs.video_name }}.mp4" ]; then
            echo "❌ Error: raw/${{ inputs.video_name }}.mp4 not found."
            echo "   Commit your raw MP4 to the raw/ directory first."
            exit 1
          fi
          echo "✅ Found raw/${{ inputs.video_name }}.mp4"
          ls -lh "raw/${{ inputs.video_name }}.mp4"

      - name: Encode WebM (VP9 + Alpha)
        if: ${{ !inputs.skip_webm }}
        run: |
          INVERT_FLAG=""
          if [ "${{ inputs.invert }}" = "true" ]; then
            INVERT_FLAG="--invert"
          fi
          chmod +x ./scripts/encode-webm.sh
          ./scripts/encode-webm.sh \
            -i "raw/${{ inputs.video_name }}.mp4" \
            -o "output/webm/${{ inputs.video_name }}/playable.webm" \
            --alpha-side "${{ inputs.alpha_side }}" \
            $INVERT_FLAG

      - name: Encode HEVC (VideoToolbox + Alpha)
        run: |
          INVERT_FLAG=""
          if [ "${{ inputs.invert }}" = "true" ]; then
            INVERT_FLAG="--invert"
          fi
          chmod +x ./scripts/encode-hevc.sh
          ./scripts/encode-hevc.sh \
            -i "raw/${{ inputs.video_name }}.mp4" \
            -o "output/hevc/${{ inputs.video_name }}/playable.mov" \
            --alpha-side "${{ inputs.alpha_side }}" \
            $INVERT_FLAG

      - name: Generate Thumbnail
        run: |
          ffmpeg -y -hide_banner -loglevel warning \
            -i "raw/${{ inputs.video_name }}.mp4" \
            -ss 1 -frames:v 1 \
            -vf "scale=512:512:force_original_aspect_ratio=decrease" \
            "output/webm/${{ inputs.video_name }}/thumbnail.png"

      - name: Upload to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          NAME="${{ inputs.video_name }}"
          CDN_PATH="${{ inputs.cdn_path }}"
          # Trim trailing slash
          CDN_PATH="${CDN_PATH%/}"
          [ "$CDN_PATH" = "" ] && CDN_PATH=""

          BUCKET="${R2_BUCKET_NAME}"
          API="https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/r2/buckets/${BUCKET}/objects"

          upload_file() {
            local FILE="$1"
            local REMOTE="$2"
            echo "  ☁️  Uploading $FILE → $REMOTE"
            curl -s -X PUT "${API}/${REMOTE}" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@${FILE}"
          }

          # Upload WebM
          if [ -f "output/webm/${NAME}/playable.webm" ]; then
            upload_file "output/webm/${NAME}/playable.webm" "${CDN_PATH}/${NAME}/playable.webm"
          fi

          # Upload HEVC
          if [ -f "output/hevc/${NAME}/playable.mov" ]; then
            upload_file "output/hevc/${NAME}/playable.mov" "${CDN_PATH}/${NAME}/playable.mov"
          fi

          # Upload Thumbnail
          if [ -f "output/webm/${NAME}/thumbnail.png" ]; then
            upload_file "output/webm/${NAME}/thumbnail.png" "${CDN_PATH}/${NAME}/thumbnail.png"
          fi

          echo "✅ All files uploaded to R2"

      - name: Update asset manifest
        run: |
          node -e "
          const fs = require('fs');
          const path = 'assets.json';
          let manifest = { version: 1, generated_at: '', assets: [] };
          if (fs.existsSync(path)) manifest = JSON.parse(fs.readFileSync(path, 'utf8'));

          const name = '${{ inputs.video_name }}';
          const cdnPath = '${{ inputs.cdn_path }}'.replace(/^\/|\/$/g, '');
          const prefix = cdnPath || name;

          // Remove existing entry
          manifest.assets = manifest.assets.filter(a => a.name !== name);
          manifest.assets.push({
            name,
            assetType: 'video',
            formats: {
              webm: prefix + '/' + name + '/playable.webm',
              hevc: prefix + '/' + name + '/playable.mov'
            },
            thumbnail: prefix + '/' + name + '/thumbnail.png',
            encoded_at: new Date().toISOString(),
            cdn_urls: []
          });
          manifest.generated_at = new Date().toISOString();
          fs.writeFileSync(path, JSON.stringify(manifest, null, 2));
          "

      - name: Commit outputs & manifest
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add assets.json output/
          git diff --cached --quiet || git commit -m "chore: encode ${{ inputs.video_name }} (WebM + HEVC)"
          git push

      - name: Summary
        run: |
          echo "## ✅ Encoding Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Asset | File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|------|" >> $GITHUB_STEP_SUMMARY
          if [ -f "output/webm/${{ inputs.video_name }}/playable.webm" ]; then
            SIZE=$(du -h "output/webm/${{ inputs.video_name }}/playable.webm" | cut -f1)
            echo "| WebM | playable.webm | $SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "output/hevc/${{ inputs.video_name }}/playable.mov" ]; then
            SIZE=$(du -h "output/hevc/${{ inputs.video_name }}/playable.mov" | cut -f1)
            echo "| HEVC | playable.mov | $SIZE |" >> $GITHUB_STEP_SUMMARY
          fi
